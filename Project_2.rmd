---
title: "Project_2"
author: "Dillon Hong"
date: "3/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

##Libraries
```{r}
library(gmodels)
library(caret)
library(class)
library(neuralnet)
library(kernlab)
library(C50)
```
## Data Cleaning and Exploration

```{r}

hotel <- read.csv("hotel_booking.csv")
hotel$arrival_date_week_number <- as.factor(hotel$arrival_date_week_number)


# Delete Unnecessary Columns

hotel$name <- NULL
hotel$email <- NULL
hotel$phone_number <- NULL
hotel$credit_card <- NULL
hotel$arrival_date_year <- NULL
hotel$arrival_date_week_number <- NULL
hotel$arrival_date_day_of_month <- NULL
hotel$reservation_status_date <- NULL
hotel$reservation_status <- NULL

#hotel$country <- ifelse(is.na(hotel$country), "No Country", na.rm = TRUE), hotel$country)

hotel$country <- NULL

#hotel$agent <- ifelse(is.na(hotel$agent), "No Agent", na.rm = TRUE), hotel$agent)
hotel$agent <- NULL

#hotel$company <- ifelse(is.na(hotel$company), "No Company", na.rm = TRUE), hotel$company)
hotel$company <- NULL


hotel <- subset(hotel, hotel == "City Hotel")
hotel$hotel <- NULL
head(hotel, 200)
```

### Check for NAs
```{r}
cbind(
   lapply(
     lapply(hotel, is.na)
     , sum)
   )
```



### Remove NAs from Children Column
```{r}
# Checking for NA values in all of the column data
hotel$children <- ifelse(is.na(hotel$children), median(hotel$children, na.rm = TRUE), hotel$children)

cbind(
   lapply(
     lapply(hotel, is.na)
     , sum)
   )
```


### Randomize and Factorize Data 
```{r}
# Randomize the rows in the data (shuffling the rows)
set.seed(12345)
hotel_random <- hotel[sample(nrow(hotel)),]

hotel_random$arrival_date_month <- as.factor(hotel_random$arrival_date_month)
hotel_random$meal <- as.factor(hotel_random$meal)

hotel_random$market_segment <- as.factor(hotel_random$market_segment)
hotel_random$distribution_channel <- as.factor(hotel_random$distribution_channel)
hotel_random$reserved_room_type <- as.factor(hotel_random$reserved_room_type)
hotel_random$assigned_room_type <- as.factor(hotel_random$assigned_room_type)
hotel_random$deposit_type <- as.factor(hotel_random$deposit_type)
hotel_random$customer_type <- as.factor(hotel_random$customer_type)


# Randomize again for good measure
hotel_random <- hotel_random[sample(nrow(hotel_random)),]
```



# Normalized Data
```{r}
#get rid of factors so we can use KNN
hotelDummy <- as.data.frame(model.matrix (~ . -1, data = hotel_random))
str(hotelDummy)

#Normalize the data
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}

#Normalize entire dataframe
hotel_norm <- as.data.frame(lapply(hotelDummy[2:ncol(hotelDummy)], normalize))

```
### Test Set

```{r}
test_set <- sample(1:nrow(hotel_random), 0.2*nrow(hotel_random))
```


## Linear Regression Model

### Train and Test Dataset
```{r}
glm_train <- hotel_random[-test_set, ]
glm_test <- hotel_random[test_set, ]

#Now the response (aka Labels) - only the yyes column
glm_train_labels <- hotel_random[-test_set, "is_canceled"]
glm_test_labels <- hotel_random[test_set, "is_canceled"]

```

### Model
```{r}
#Ryan
#best r squared and most significant variables
glm_model <- glm(is_canceled ~ lead_time + stays_in_week_nights + adr + is_repeated_guest + previous_cancellations +  meal + previous_bookings_not_canceled +   booking_changes + deposit_type + customer_type + total_of_special_requests, data = glm_train, family = 'binomial')
summary(glm_model)
```

### Predictions
```{r}
glm_prediction <- predict(glm_model, glm_test, type="response")
glm_prediction <- as.factor(ifelse(glm_prediction>0.5,1,0))

write.csv(glm_prediction, "hotel_glm_predictions.csv")
```

### Matrix
```{r}
glm_matrix <- confusionMatrix(glm_prediction, as.factor(glm_test_labels), positive = '1')
glm_matrix
```



## KNN Model 

### Train and Test Dataset
```{r}
knn_train <- hotel_norm[-test_set, ]
knn_test <- hotel_norm[test_set, ]

#Now the response (aka Labels) - only the is_canceled column
knn_train_labels <- hotel_random[-test_set, "is_canceled"]
knn_test_labels <- hotel_random[test_set, "is_canceled"]
```

###Model and Predictions
```{r}
hotel_knn <- knn(train = knn_train, test = knn_test,
                      cl = knn_train_labels, k=sqrt(length(knn_train_labels)))
write.csv(hotel_knn, "hotel_knn_predictions.csv")
```

###Confusion Matrix
```{r}
knn_matrix <- confusionMatrix(as.factor(hotel_knn), as.factor(knn_test_labels))
knn_matrix
```

## ANN Model 


### Train and Test Dataset
```{r}
hotel_norm$is_canceled <- hotel_random$is_canceled

ann_train <- hotel_norm[-test_set, ]
ann_test <- hotel_norm[test_set, ]

#Now the response (aka Labels) - only the yyes column
ann_train_labels <- hotel_norm[-test_set, "is_canceled"]
ann_test_labels <- hotel_norm[test_set, "is_canceled"]
```

###Model
```{r}
hotel_ann <- neuralnet(formula = is_canceled ~ .,data = ann_train, hidden = 3)
```

###Prediction
```{r}

ann_predictions <- predict(hotel_ann, ann_test, type="response")
ann_predictions <- as.factor(ifelse(ann_predictions>0.5,1,0))

write.csv(ann_predictions, "hotel_ann_predictions.csv")
```

###Confusion Matrix
```{r}
ann_maxtrix <- confusionMatrix(ann_predictions, as.factor(ann_test_labels))
ann_maxtrix
```

##SVM

###Train and Test Datasets
```{r}
svm_train <- hotel_random[-test_set, ]
svm_test <- hotel_random[test_set, ]

svm_train_labels <- hotel_random[-test_set, "is_canceled"]
svm_test_labels <- hotel_random[test_set, "is_canceled"]
```

### Model
```{r}
svm <- ksvm(is_canceled ~ ., data = svm_train, kernel = "vanilladot")
```

###Prediction
```{r}
svm_predictions <- predict(svm, svm_test, type= "response")
svm_predictions <- as.factor(ifelse(svm_predictions > 0.5, 1, 0))

write.csv(ann_predictions, "hotel_svm_predictions.csv")
```

###Confusion Matrix
```{r}
svm_matrix <- confusionMatrix(svm_predictions, as.factor(svm_test_labels))
svm_matrix
```


##Decision Tree

###Train and Test Datasets
```{r}
tree_train <- hotel_random[-test_set, ]
tree_test <- hotel_random[test_set, ]


prop.table(table(tree_train$is_canceled))
prop.table(table(tree_test$is_canceled))
```

###Model
```{r}
hotel_decision_model <- C5.0(as.factor(is_canceled) ~ ., data = tree_train, trials = 10)
```

###Prediction
```{r}

c50_hotel_pred <- predict(hotel_decision_model, tree_test)
write.csv(c50_hotel_pred, "hotel_c50_predictions.csv")
```

###Confusion Matrix
```{r}
c50_matrix <- confusionMatrix(c50_hotel_pred, as.factor(tree_test$is_canceled))
c50_matrix
```



##Stacked Model

```{r}
glm_predictions <- read.csv("hotel_glm_predictions.csv")
knn_predictions <- read.csv("hotel_knn_predictions.csv")
ann_predictions <- read.csv("hotel_ann_predictions.csv")
svm_predictions <- read.csv("hotel_svm_predictions.csv")
c50_predictions <- read.csv("hotel_c50_predictions.csv")

combo_set <- data.frame(glm_test$is_canceled, glm_predictions$x, knn_predictions$x, ann_predictions$x, svm_predictions$x, c50_predictions$x)
colnames(combo_set) <- c("Actual", "GLM", "KNN", "ANN", "SVM","TREE")

combo_set$Actual <- as.factor(combo_set$Actual)
```

### Test and Train
```{r}
#Set up training data
test_stacked_set <- sample(1:nrow(combo_set), 0.2*nrow(combo_set))

stacked_train <- combo_set[-test_stacked_set,]
stacked_test <- combo_set[test_stacked_set,]

```

###Model
```{r}

#hotel_decision_model <- C5.0(hotel_train[-1], as.factor(hotel_train$is_canceled), trials = 10)
hotel_stacked_model <- C5.0(as.factor(Actual) ~ ., data = stacked_train, trials = 20)
summary(hotel_stacked_model)
plot(hotel_stacked_model)
```

###Prediction
```{r}
stacked_predictions <- predict(hotel_stacked_model, stacked_test)
```

###Confusion Matrix
```{r}
stacked_matrix <- confusionMatrix(stacked_predictions, as.factor(stacked_test$Actual))
stacked_matrix
```

##Conclusion
